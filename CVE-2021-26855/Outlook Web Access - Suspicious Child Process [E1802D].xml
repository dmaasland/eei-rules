<?xml version="1.0" encoding="UTF-8"?>
<ruleMetadata>
    <isInternal>false</isInternal>
    <guid>e805eac0-8d95-423d-b6fb-2de463e8262b</guid>
    <rule>
        <description>
            <os>Windows</os>
            <mitreattackid>T1505.003</mitreattackid>
            <name>Outlook Web Access - Suspicious Child Process [E1802D]</name>
            <category>Suspicious process creation and process manipulation</category>
            <explanation>IIS Web server process usually does not create any child processes.</explanation>
            <maliciousCauses>A backdoor is executing commands - external programs in a new process</maliciousCauses>
            <benignCauses>Legitimate script is creating a new process</benignCauses>
            <recommendedActions>If the new process is known and legitimate - part of a web application - add an exclusion to this rule.</recommendedActions>
            <severity>75</severity>
        </description>
        <definition>
            <ParentProcess>
                <condition component="FileItem" condition="is" property="FileName" value="svchost.exe" />
            </ParentProcess>
            <Process>
                <operator type="AND">
                    <condition component="FileItem" condition="is" property="FileName" value="w3wp.exe" />
                    <!-- IIS worker process-->
                    <operator type="OR">
                        <condition component="FileItem" property="Path" condition="is" value="%SYSTEM%\inetsrv\" />
                        <condition component="FileItem" property="Path" condition="is" value="%WINDIR%\syswow64\inetsrv\" />
                    </operator>
                    <condition component="ProcessInfo" property="CommandLine" condition="contains" value="-ap &quot;MSExchangeOWAAppPool&quot;" />
                </operator>
            </Process>
            <operations>
                <operation type="CreateProcess">
                    <operator type="AND">
                        <condition component="FileItem" condition="isnotempty" property="FileName" />
                        <!-- ASP(X) interpreter cant be determined from process tree-->
                        <!-- "Whitelist" of interpreters &amp; compilers-->
                        <operator type="OR">
                            <condition component="FileItem" condition="isnot" property="FileName" value="php-cgi.exe" />
                            <condition component="LiveGrid" condition="less" property="Popularity" value="1000" />
                            <!-- php-cgi.exe is not signed -->
                        </operator>
                        <operator type="OR">
                            <condition component="FileItem" condition="isnot" property="FileName" value="python.exe" />
                            <condition component="Module" condition="isnot" property="SignatureType" value="Trusted" />
                            <condition component="Module" condition="isnot" property="SignerName" value="Python Software Foundation" />
                        </operator>
                        <operator type="OR">
                            <condition component="FileItem" condition="isnot" property="FileName" value="perl.exe" />
                            <condition component="LiveGrid" condition="less" property="Popularity" value="1000" />
                            <!-- perl.exe is not signed -->
                        </operator>
                        <!--ASP compilers-->
                        <operator type="OR">
                            <operator type="AND">
                                <condition component="FileItem" condition="isnot" property="FileName" value="csc.exe" />
                                <condition component="FileItem" condition="isnot" property="FileName" value="vbc.exe" />
                                <condition component="FileItem" condition="isnot" property="FileName" value="cvtres.exe" />
                            </operator>
                            <condition component="Module" condition="isnot" property="SignatureType" value="Trusted" />
                            <condition component="Module" condition="isnot" property="SignerName" value="Microsoft Corporation" />
                        </operator>
                        <!--crash handler-->
                        <operator type="or">
                            <condition component="FileItem" property="FileName" condition="isnot" value="wermgr.exe" />
                            <operator type="and">
                                <condition component="FileItem" property="Path" condition="isnot" value="%SYSTEM%" />
                                <condition component="FileItem" property="Path" condition="isnot" value="%WINDIR%\syswow64" />
                            </operator>
                            <condition component="Module" property="SignerName" condition="isnot" value="Microsoft Windows" />
                            <condition component="Module" property="SignatureType" condition="isnot" value="Trusted" />
                        </operator>
                    </operator>
                </operation>
            </operations>
        </definition>
    </rule>
</ruleMetadata>