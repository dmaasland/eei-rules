<?xml version="1.0" encoding="utf-8"?>
<rule>
    <definition>
        <process>
            <operator type="AND">
                <condition component="FileItem" property="Path" condition="is" value="%SYSTEM%\" />
                <condition component="FileItem" property="FileNameWithoutExtension" condition="is" value="spoolsv" />
            </operator>
        </process>
        <operations>
            <operation type="LoadDLL">
                <operator type="AND">
                    <condition component="LiveGrid" condition="less" property="Reputation" value="8" />
                    <condition component="Module" condition="isnot" property="SignatureType" value="trusted" />
                    <condition component="FileItem" condition="starts" property="Path" value="%SYSTEM%\spool\drivers\" />
                    <operator type="OR">
                        <condition component="LiveGrid" condition="less" property="Popularity" value="100" />
                        <condition component="LiveGrid" condition="less" property="Reputation" value="4" />
                    </operator>
                    <condition component="Enterprise" condition="isnot" property="Safe" value="1" />
                </operator>
            </operation>
        </operations>
    </definition>
    <description>
        <os>Windows</os>
        <mitreattackid>T1574.002</mitreattackid>
        <explanation>This rule detects the potential exploitation of CVE-2021-1675 (PrinterNightmare). Specifically, spoolsv.exe loading a .dll file with a low reputation from the spool drivers folder.</explanation>
        <maliciousCauses>An attacker may be attempting to gain access to the system by exploiting CVE-2021-1675.</maliciousCauses>
        <benignCauses>Program loaded legitimate DLL library, which is very rare or fresh. It may include driver components for rare hardware, custom libraries compiled for a specific customer, or even on specific computers, etc.</benignCauses>
        <recommendedActions>1. Verify which DLL caused the detection and its attributes. Is it part of an intentionally installed program?
2. Verify the source of the DLL library. If applicable, compare it to the official distribution package.
3. Inspect the behavior of the program that loaded the library. Was it used elsewhere in your environment?
4. Scan the DLL library with an updated Antivirus program.
5. If the DLL is suspicious, submit it for further analysis.</recommendedActions>
        <category>Exploitation</category>
        <name>PrinterNightmare - Printer Spooler loaded untrusted DLL [K1989B]</name>
        <severity>80</severity>
    </description>
</rule>
